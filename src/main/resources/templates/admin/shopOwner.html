<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Cửa hàng - PMLS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="/css/chat.css">
    <style>
        *{
            font-family: 'Times New Roman', Times, serif;
        }
    </style>
</head>
<body class="bg-gray-100" x-data="{ 
    sidebarOpen: true,
    activeSection: 'dashboard',
    // Staff management
    staff: [],
    newStaff: { 
        fullName: '', 
        email: '', 
        phone: '', 
        passwordHash: '', 
        shopId: null, 
        role: '' 
    },
    editingStaff: null,
    showStaffModal: false,

    // Services management
    services: [],
    newService: { serviceName: '', price: '' },
    editingService: null,
    showServiceModal: false,

    // Shop profile
    shopProfile: {
        id: null,
        shopName: '',
        location: '',
        operatingHours: '',
        servicesOffered: '',
        ownerId: null
    },
    isEditingProfile: false,

    // Initialize
    async init() {
        await this.loadServices();
        await this.loadShopProfile();
        await this.loadStaff();
    },

    // Format price
    formatPrice(price) {
        return new Intl.NumberFormat('vi-VN').format(price);
    },

    // Shop profile methods
    async loadShopProfile() {
        try {
            console.log('Loading shop profile...');
            // Lấy shopId từ URL hoặc session
            const shopId = 1; // Thay thế bằng shopId thực tế
            
            const response = await fetch(`http://localhost:8080/api/shops/${shopId}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log('Shop profile loaded:', data);
            
            // Cập nhật dữ liệu hồ sơ cửa hàng
            this.shopProfile = {
                id: data.id,
                shopName: data.shopName,
                location: data.location,
                operatingHours: data.operatingHours,
                servicesOffered: data.servicesOffered,
                ownerId: data.ownerId
            };

            // Cập nhật text logo thành tên cửa hàng
            const logoText = document.querySelector('.logo-text');
            if (logoText) {
                logoText.textContent = data.shopName;
            }
            
            // Tách giờ mở cửa và đóng cửa
            if (data.operatingHours) {
                const [openTime, closeTime] = data.operatingHours.split(' - ');
                this.shopProfile.openTime = openTime || '08:00';
                this.shopProfile.closeTime = closeTime || '18:00';
            } else {
                this.shopProfile.openTime = '08:00';
                this.shopProfile.closeTime = '18:00';
            }
            
            // Tách danh sách dịch vụ
            if (data.servicesOffered) {
                this.shopProfile.services = data.servicesOffered.split(', ');
            } else {
                this.shopProfile.services = [];
            }
        } catch (error) {
            console.error('Error loading shop profile:', error);
            alert('Không thể tải thông tin cửa hàng. Vui lòng thử lại sau.');
        }
    },

    async saveProfile() {
        try {
            if (!this.shopProfile.shopName || !this.shopProfile.location) {
                alert('Vui lòng điền đầy đủ thông tin cửa hàng');
                return;
            }
            
            // Kết hợp giờ mở cửa và đóng cửa
            const operatingHours = `${this.shopProfile.openTime} - ${this.shopProfile.closeTime}`;
            
            // Kết hợp danh sách dịch vụ
            const servicesOffered = this.shopProfile.services.join(', ');
            
            const shopData = {
                id: this.shopProfile.id,
                shopName: this.shopProfile.shopName,
                location: this.shopProfile.location,
                operatingHours: operatingHours,
                servicesOffered: servicesOffered,
                ownerId: this.shopProfile.ownerId
            };
            
            console.log('Saving shop profile:', shopData);
            
            const response = await fetch(`http://localhost:8080/api/shops/${this.shopProfile.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(shopData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const updatedShop = await response.json();
            console.log('Shop profile updated:', updatedShop);
            
            this.isEditingProfile = false;
            alert('Cập nhật thông tin cửa hàng thành công!');
        } catch (error) {
            console.error('Error saving shop profile:', error);
            alert('Không thể cập nhật thông tin cửa hàng. Vui lòng thử lại sau.');
        }
    },

    // Services methods
    async loadServices() {
        try {
            console.log('Loading services...');
            const response = await fetch('http://localhost:8080/api/services');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log('Services loaded:', data);
            this.services = data;
        } catch (error) {
            console.error('Error loading services:', error);
            alert('Không thể tải danh sách dịch vụ. Vui lòng thử lại sau.');
        }
    },

    async addService() {
        try {
            if (!this.newService.serviceName || !this.newService.price) {
                alert('Vui lòng điền đầy đủ thông tin dịch vụ');
                return;
            }

            const response = await fetch('http://localhost:8080/api/services', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    serviceName: this.newService.serviceName,
                    price: parseFloat(this.newService.price),
                    shopId: this.shopProfile.id // Sử dụng shopId từ hồ sơ cửa hàng
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const newService = await response.json();
            this.services.push(newService);
            this.newService = { serviceName: '', price: '' };
            this.showServiceModal = false;
            alert('Thêm dịch vụ thành công!');
        } catch (error) {
            console.error('Error adding service:', error);
            alert('Không thể thêm dịch vụ. Vui lòng thử lại sau.');
        }
    },

    async updateService() {
        try {
            if (!this.editingService.serviceName || !this.editingService.price) {
                alert('Vui lòng điền đầy đủ thông tin dịch vụ');
                return;
            }

            const response = await fetch(`http://localhost:8080/api/services/${this.editingService.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(this.editingService)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const updatedService = await response.json();
            const index = this.services.findIndex(s => s.id === updatedService.id);
            if (index !== -1) {
                this.services[index] = updatedService;
            }
            this.editingService = null;
            this.showServiceModal = false;
            alert('Cập nhật dịch vụ thành công!');
        } catch (error) {
            console.error('Error updating service:', error);
            alert('Không thể cập nhật dịch vụ. Vui lòng thử lại sau.');
        }
    },

    async deleteService(id) {
        if (!confirm('Bạn có chắc chắn muốn xóa dịch vụ này?')) {
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/api/services/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            this.services = this.services.filter(s => s.id !== id);
            alert('Xóa dịch vụ thành công!');
        } catch (error) {
            console.error('Error deleting service:', error);
            alert('Không thể xóa dịch vụ. Vui lòng thử lại sau.');
        }
    },

    editService(service) {
        this.editingService = { ...service };
        this.showServiceModal = true;
    },

    // Staff methods
    async loadStaff() {
        try {
            console.log('Loading staff...');
            const response = await fetch(`http://localhost:8080/api/staff/shop/${this.shopProfile.id}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log('Staff loaded:', data);
            this.staff = data;
        } catch (error) {
            console.error('Error loading staff:', error);
            alert('Không thể tải danh sách nhân viên. Vui lòng thử lại sau.');
        }
    },

    async addStaff() {
        try {
            if (!this.newStaff.fullName || !this.newStaff.email || !this.newStaff.phone || !this.newStaff.role) {
                alert('Vui lòng điền đầy đủ thông tin nhân viên');
                return;
            }

            this.newStaff.shopId = this.shopProfile.id;
            this.newStaff.passwordHash = 'default123'; // You should implement proper password hashing

            const response = await fetch('http://localhost:8080/api/staff', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(this.newStaff)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const newStaff = await response.json();
            this.staff.push(newStaff);
            this.newStaff = { 
                fullName: '', 
                email: '', 
                phone: '', 
                passwordHash: '', 
                shopId: null, 
                role: '' 
            };
            this.showStaffModal = false;
            alert('Thêm nhân viên thành công!');
        } catch (error) {
            console.error('Error adding staff:', error);
            alert('Không thể thêm nhân viên. Vui lòng thử lại sau.');
        }
    },

    async updateStaff() {
        try {
            if (!this.editingStaff.fullName || !this.editingStaff.email || !this.editingStaff.phone || !this.editingStaff.role) {
                alert('Vui lòng điền đầy đủ thông tin nhân viên');
                return;
            }

            const response = await fetch(`http://localhost:8080/api/staff/${this.editingStaff.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(this.editingStaff)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const updatedStaff = await response.json();
            const index = this.staff.findIndex(s => s.id === updatedStaff.id);
            if (index !== -1) {
                this.staff[index] = updatedStaff;
            }
            this.editingStaff = null;
            this.showStaffModal = false;
            alert('Cập nhật nhân viên thành công!');
        } catch (error) {
            console.error('Error updating staff:', error);
            alert('Không thể cập nhật nhân viên. Vui lòng thử lại sau.');
        }
    },

    async deleteStaff(id) {
        if (!confirm('Bạn có chắc chắn muốn xóa nhân viên này?')) {
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/api/staff/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            this.staff = this.staff.filter(s => s.id !== id);
            alert('Xóa nhân viên thành công!');
        } catch (error) {
            console.error('Error deleting staff:', error);
            alert('Không thể xóa nhân viên. Vui lòng thử lại sau.');
        }
    },

    editStaff(staff) {
        this.editingStaff = { ...staff };
        this.showStaffModal = true;
    }
}">
<!-- Sidebar -->
<div class="fixed inset-y-0 left-0 bg-[#1F2937] text-white w-64 transform transition-transform duration-300 ease-in-out z-50"
     :class="{'translate-x-0': sidebarOpen, '-translate-x-full': !sidebarOpen}">
    <div class="p-4">
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center space-x-4">
                <div class="relative" x-data="{ open: false }">
                    <button @click="open = !open" class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <img src="https://storage.googleapis.com/a1aa/image/hd1mAGyVCYYPVAtfkt7e6lWmPMG3mDW6LAtKRO2mzfs.jpg" 
                             alt="Shop Logo" class="w-10 h-10 rounded-full">
                            <span class="logo-text ml-2 text-xl font-bold">Chủ cửa hàng</span>
                        </div>
                    </button>
                    <div x-show="open" @click.away="open = false"
                         class="absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-user mr-2"></i>Thông tin cá nhân
                        </a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-cog mr-2"></i>Cài đặt
                        </a>
                        <a href="/index" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-sign-out-alt mr-2"></i>Đăng xuất
                        </a>
                    </div>
                </div>
            </div>
            <button @click="sidebarOpen = false" class="lg:hidden">
                <i class="fas fa-times text-white"></i>
            </button>
        </div>
        <nav class="space-y-2">
            <a href="#" @click.prevent="activeSection = 'dashboard'"
               class="flex items-center space-x-2 p-2 rounded hover:bg-gray-700"
               :class="{'bg-gray-700': activeSection === 'dashboard'}">
                <i class="fas fa-tachometer-alt"></i>
                <span>Tổng quan</span>
            </a>
            <a href="#" @click.prevent="activeSection = 'profile'"
               class="flex items-center space-x-2 p-2 rounded hover:bg-gray-700"
               :class="{'bg-gray-700': activeSection === 'profile'}">
                <i class="fas fa-store"></i>
                <span>Hồ sơ cửa hàng</span>
            </a>
            <a href="#" @click.prevent="activeSection = 'staff'"
               class="flex items-center space-x-2 p-2 rounded hover:bg-gray-700"
               :class="{'bg-gray-700': activeSection === 'staff'}">
                <i class="fas fa-users"></i>
                <span>Quản lý nhân viên</span>
            </a>
            <a href="#" @click.prevent="activeSection = 'services'"
               class="flex items-center space-x-2 p-2 rounded hover:bg-gray-700"
               :class="{'bg-gray-700': activeSection === 'services'}">
                <i class="fas fa-list"></i>
                <span>Dịch vụ & Bảng giá</span>
            </a>
            <a href="#" @click.prevent="activeSection = 'orders'"
               class="flex items-center space-x-2 p-2 rounded hover:bg-gray-700"
               :class="{'bg-gray-700': activeSection === 'orders'}">
                <i class="fas fa-shopping-cart"></i>
                <span>Đơn hàng</span>
            </a>
            <a href="#" @click.prevent="activeSection = 'reports'"
               class="flex items-center space-x-2 p-2 rounded hover:bg-gray-700"
               :class="{'bg-gray-700': activeSection === 'reports'}">
                <i class="fas fa-chart-bar"></i>
                <span>Báo cáo</span>
            </a>
        </nav>
    </div>
</div>

<!-- Main Content -->
<div class="ml-0 lg:ml-64 transition-margin duration-300 ease-in-out">
    <!-- Top Bar -->
    <div class="bg-white shadow-sm p-4">
        <div class="flex items-center justify-between">
            <button @click="sidebarOpen = true" class="lg:hidden text-gray-600">
                <i class="fas fa-bars"></i>
            </button>
            <div class="flex items-center space-x-4">
                <!-- Notifications -->
                <div class="relative">
                    <button class="text-gray-600 hover:text-gray-800">
                        <i class="fas fa-bell"></i>
                        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">3</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Content -->
    <main class="p-6">
        <!-- Dashboard Section -->
        <div x-show="activeSection === 'dashboard'">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <!-- Tổng đơn hàng -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Tổng đơn hàng</p>
                            <h3 class="text-2xl font-semibold" id="total-orders">0</h3>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-shopping-cart text-blue-600"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <span id="orders-growth"></span>
                        <span class="text-gray-500 text-sm ml-2">so với tháng trước</span>
                    </div>
                </div>

                <!-- Doanh thu -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Doanh thu</p>
                            <h3 class="text-2xl font-semibold" id="total-revenue">0đ</h3>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-dollar-sign text-green-600"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <span id="revenue-growth"></span>
                        <span class="text-gray-500 text-sm ml-2">so với tháng trước</span>
                    </div>
                </div>

                <!-- Khách hàng mới -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Khách hàng mới</p>
                            <h3 class="text-2xl font-semibold" id="new-customers">0</h3>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <i class="fas fa-users text-purple-600"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <span id="customers-growth"></span>
                        <span class="text-gray-500 text-sm ml-2">so với tháng trước</span>
                    </div>
                </div>

                <!-- Đơn hàng đang xử lý -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Đơn hàng đang xử lý</p>
                            <h3 class="text-2xl font-semibold" id="pending-orders">0</h3>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-full">
                            <i class="fas fa-clock text-yellow-600"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button class="text-blue-600 hover:text-blue-800 text-sm">
                            Xem chi tiết
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filters and Actions -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center space-x-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Thời gian</label>
                            <input type="date" id="date-filter"
                                   class="mt-1 block rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Trạng thái</label>
                            <select id="status-filter"
                                    class="mt-1 block rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="all">Tất cả</option>
                                <option value="Received">Chờ xử lý</option>
                                <option value="In Progress">Đang xử lý</option>
                                <option value="Completed">Hoàn thành</option>
                                <option value="Cancelled">Đã hủy</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button data-report-type="daily"
                                class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            <i class="fas fa-download mr-2"></i>Xuất báo cáo ngày
                        </button>
                        <button data-report-type="monthly"
                                class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                            <i class="fas fa-download mr-2"></i>Xuất báo cáo tháng
                        </button>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Biểu đồ doanh thu -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Doanh thu theo tháng</h3>
                    <canvas id="revenueChart"></canvas>
                </div>
                <!-- Biểu đồ dịch vụ -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Phân bố dịch vụ</h3>
                    <canvas id="servicesChart"></canvas>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold">Đơn hàng gần đây</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full recent-orders">
                        <thead class="bg-gray-50">
                        <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mã đơn</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Khách hàng</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dịch vụ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tổng tiền</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trạng thái</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thao tác</th>
                        </tr>
                        </thead>
                        <tbody>
                            <!-- Đơn hàng sẽ được render bởi JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Profile Section -->
        <div x-show="activeSection === 'profile'" class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">Hồ sơ cửa hàng</h2>
                <button @click="isEditingProfile = !isEditingProfile"
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                    <i :class="isEditingProfile ? 'fas fa-times' : 'fas fa-edit'" class="mr-2"></i>
                    <span x-text="isEditingProfile ? 'Hủy' : 'Chỉnh sửa'"></span>
                </button>
            </div>
            <form @submit.prevent="saveProfile" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tên cửa hàng</label>
                        <input type="text" x-model="shopProfile.shopName"
                               :disabled="!isEditingProfile"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Địa chỉ</label>
                        <input type="text" x-model="shopProfile.location"
                               :disabled="!isEditingProfile"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Giờ hoạt động</label>
                    <div class="mt-1 grid grid-cols-2 gap-4">
                        <input type="time" x-model="shopProfile.openTime"
                               :disabled="!isEditingProfile"
                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <input type="time" x-model="shopProfile.closeTime"
                               :disabled="!isEditingProfile"
                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Dịch vụ cung cấp</label>
                    <div class="mt-2 space-y-2">
                        <template x-for="service in services" :key="service.id">
                            <label class="inline-flex items-center">
                                <input type="checkbox"
                                       :disabled="!isEditingProfile"
                                       :checked="shopProfile.services && shopProfile.services.includes(service.serviceName)"
                                       @change="isEditingProfile && (shopProfile.services ? (shopProfile.services.includes(service.serviceName) ?
                                                shopProfile.services = shopProfile.services.filter(s => s !== service.serviceName) :
                                                shopProfile.services.push(service.serviceName)) : (shopProfile.services = [service.serviceName]))"
                                       class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <span class="ml-2" x-text="service.serviceName"></span>
                            </label>
                        </template>
                    </div>
                </div>
                <div class="flex justify-end" x-show="isEditingProfile">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-save mr-2"></i>Lưu thay đổi
                    </button>
                </div>
            </form>
        </div>

        <!-- Staff Section -->
        <div x-show="activeSection === 'staff'" class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">Quản lý nhân viên</h2>
                <button @click="showStaffModal = true" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                    <i class="fas fa-plus mr-2"></i>Thêm nhân viên
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-2 px-4 border-b">Tên</th>
                            <th class="py-2 px-4 border-b">Email</th>
                            <th class="py-2 px-4 border-b">Số điện thoại</th>
                            <th class="py-2 px-4 border-b">Vai trò</th>
                            <th class="py-2 px-4 border-b">Thao tác</th>
                    </tr>
                    </thead>
                    <tbody>
                        <template x-for="member in staff" :key="member.id">
                            <tr>
                                <td class="py-2 px-4 border-b" x-text="member.fullName"></td>
                                <td class="py-2 px-4 border-b" x-text="member.email"></td>
                                <td class="py-2 px-4 border-b" x-text="member.phone"></td>
                                <td class="py-2 px-4 border-b" x-text="member.role"></td>
                                <td class="py-2 px-4 border-b">
                                    <button @click="editStaff(member)" class="bg-blue-500 text-white px-2 py-1 rounded mr-2">Sửa</button>
                                    <button @click="deleteStaff(member.id)" class="bg-red-500 text-white px-2 py-1 rounded">Xóa</button>
                            </td>
                        </tr>
                    </template>
                    </tbody>
                </table>
            </div>

            <!-- Staff Modal -->
            <div x-show="showStaffModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">
                            <span x-text="editingStaff ? 'Chỉnh sửa nhân viên' : 'Thêm nhân viên mới'"></span>
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tên</label>
                                <input type="text"
                                       x-model="editingStaff ? editingStaff.fullName : newStaff.fullName"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email"
                                       x-model="editingStaff ? editingStaff.email : newStaff.email"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Số điện thoại</label>
                                <input type="tel"
                                       x-model="editingStaff ? editingStaff.phone : newStaff.phone"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Vai trò</label>
                                <input type="text"
                                       x-model="editingStaff ? editingStaff.role : newStaff.role"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="mt-5 flex justify-end space-x-3">
                            <button @click="showStaffModal = false"
                                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">
                                Hủy
                            </button>
                            <button @click="editingStaff ? updateStaff() : addStaff()"
                                    class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                <span x-text="editingStaff ? 'Cập nhật' : 'Thêm'"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Services Section -->
        <div x-show="activeSection === 'services'" class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">Dịch vụ & Bảng giá</h2>
                <button @click="showServiceModal = true" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                    <i class="fas fa-plus mr-2"></i>Thêm dịch vụ
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <template x-for="service in services" :key="service.id">
                    <div class="border rounded-lg p-4">
                        <h3 class="text-lg font-semibold mb-2" x-text="service.serviceName"></h3>
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold" x-text="formatPrice(service.price) + 'đ/kg'"></span>
                            <div>
                                <button @click="editService(service)" class="text-blue-600 hover:text-blue-900 mr-3">
                                    <i class="fas fa-edit"></i> Sửa
                                </button>
                                <button @click="deleteService(service.id)" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i> Xóa
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Modal dịch vụ -->
            <div x-show="showServiceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">
                            <span x-text="editingService ? 'Chỉnh sửa dịch vụ' : 'Thêm dịch vụ mới'"></span>
                        </h3>
                        <form @submit.prevent="editingService ? updateService() : addService()" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tên dịch vụ</label>
                                <input type="text"
                                       x-model="editingService ? editingService.serviceName : newService.serviceName"
                                       required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Giá (đ/kg)</label>
                                <input type="number"
                                       x-model="editingService ? editingService.price : newService.price"
                                       required
                                       min="0"
                                       step="1000"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div class="mt-5 flex justify-end space-x-3">
                                <button type="button" @click="showServiceModal = false"
                                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">
                                Hủy
                            </button>
                                <button type="submit"
                                    class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                <span x-text="editingService ? 'Cập nhật' : 'Thêm'"></span>
                            </button>
                        </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Section -->
        <div x-show="activeSection === 'orders'" class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">Quản lý đơn hàng</h2>
                <div class="flex space-x-4">
                    <select class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option>Tất cả trạng thái</option>
                        <option>Chờ xử lý</option>
                        <option>Đang xử lý</option>
                        <option>Hoàn thành</option>
                        <option>Đã hủy</option>
                    </select>
                    <input type="date" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mã đơn</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Khách hàng</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dịch vụ</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tổng tiền</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ngày tạo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trạng thái</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thao tác</th>
                    </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                    <tr>
                        <td class="px-6 py-4">#12345</td>
                        <td class="px-6 py-4">Nguyễn Văn A</td>
                        <td class="px-6 py-4">Giặt & Ủi</td>
                        <td class="px-6 py-4">150.000đ</td>
                        <td class="px-6 py-4">2024-03-20</td>
                        <td class="px-6 py-4">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                        Hoàn thành
                                    </span>
                        </td>
                        <td class="px-6 py-4">
                            <button class="text-blue-600 hover:text-blue-900">Chi tiết</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Reports Section -->
        <div x-show="activeSection === 'reports'" class="bg-white rounded-lg shadow p-6">
            <h2 class="text-2xl font-semibold mb-6">Báo cáo & Thống kê</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold mb-4">Doanh thu theo tháng</h3>
                    <canvas id="monthlyRevenueChart"></canvas>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4">Top dịch vụ bán chạy</h3>
                    <canvas id="topServicesChart"></canvas>
                </div>
            </div>
            <div class="mt-6">
                <h3 class="text-lg font-semibold mb-4">Báo cáo chi tiết</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thời gian</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Doanh thu</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Số đơn</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Khách hàng mới</th>
                        </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                        <tr>
                            <td class="px-6 py-4">Tháng 3/2024</td>
                            <td class="px-6 py-4">15.000.000đ</td>
                            <td class="px-6 py-4">150</td>
                            <td class="px-6 py-4">25</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Order Details Modal -->
<div id="orderDetailsModal" 
     x-data="{ open: false, order: null }" 
     x-show="open"
     class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"
     x-cloak>
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="order-details">
            <!-- Chi tiết đơn hàng sẽ được render bởi JavaScript -->
        </div>
        <div class="mt-4 flex justify-end">
            <button @click="open = false"
                    class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                Đóng
            </button>
        </div>
    </div>
</div>

<!-- Chat Widget -->
<div class="chat-widget">
    <button class="toggle-chat-button bg-[#1F2937] text-white">
        <i class="fas fa-comments"></i>
        <span class="chat-unread-badge bg-red-500 text-white hidden">0</span>
    </button>
    <div class="chat-container bg-white" style="display: none;">
        <div class="chat-header bg-[#1F2937] text-white">
            <div class="chat-title">Chat với khách hàng</div>
            <div class="chat-close-button">
                <i class="fas fa-times"></i>
            </div>
        </div>
        <div class="chat-messages">
            <!-- Tin nhắn sẽ được render bởi JavaScript -->
        </div>
        <div class="chat-footer">
            <form class="chat-form">
                <input type="text" class="chat-input" placeholder="Nhập tin nhắn...">
                <button type="submit" class="chat-send-button bg-[#1F2937] text-white">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stomp-websocket@2.3.4/lib/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Cấu hình ứng dụng
    window.laundryConfig = {
        simulationMode: true,  // Bật chế độ giả lập khi API chưa hoàn thiện
        debug: false           // Cấu hình debug
    };
</script>
<script src="/js/chatManager.js"></script>
<script src="/js/dashboard.js"></script>
<script src="/js/shopOwner.js"></script>

<!-- Debug Chat -->
<script>
// Hiển thị debug cho chat widget khi load xong trang
document.addEventListener('DOMContentLoaded', function() {
    console.log('Debug: Kiểm tra phần tử chat');
    const chatInput = document.querySelector('.chat-input');
    const chatSendButton = document.querySelector('.chat-send-button');
    const chatForm = document.querySelector('.chat-form');
    
    console.log('Chat input:', chatInput);
    console.log('Chat send button:', chatSendButton);
    console.log('Chat form:', chatForm);
    
    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            console.log('Form chat đã được submit bằng debug');
        });
    }
    
    if (chatSendButton) {
        chatSendButton.addEventListener('click', function(e) {
            console.log('Nút gửi đã được click bằng debug');
        });
    }
});
</script>

<!-- Thêm Script xử lý đơn hàng phía cuối file, trước thẻ đóng body -->
<script>
// Xử lý quản lý đơn hàng cho chủ cửa hàng
document.addEventListener('DOMContentLoaded', function() {
    // Đăng ký thêm dữ liệu cho Alpine.js
    window.Alpine.data('orderManagement', () => ({
        // Dữ liệu quản lý đơn hàng
        ordersTab: 'all',
        newOrdersCount: 0,
        orders: [],
        
        // Khởi tạo
        init() {
            // Lấy thông tin shop từ localStorage hoặc URL
            this.loadShopInfo();
            
            // Tải danh sách đơn hàng
            this.loadOrders();
            
            // Kiểm tra đơn hàng mới mỗi 30 giây
            setInterval(() => {
                this.checkNewOrders();
            }, 30000);
        },
        
        // Lấy thông tin cửa hàng
        loadShopInfo() {
            // Ưu tiên lấy từ localStorage nếu có
            const userData = localStorage.getItem('user');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    if (user && user.shopId) {
                        this.shopId = user.shopId;
                        return;
                    }
                } catch (error) {
                    console.warn('Lỗi khi parse dữ liệu user từ localStorage:', error);
                }
            }
            
            // Nếu không có trong localStorage, thử lấy từ URL
            const urlParams = new URLSearchParams(window.location.search);
            this.shopId = urlParams.get('shopId') || 1; // Mặc định là shop ID 1 nếu không tìm thấy
        },
        
        // Lấy danh sách đơn hàng từ server
        async loadOrders() {
            try {
                if (!this.shopId) return;
                
                try {
                    const response = await fetch(`/api/orders/shop/${this.shopId}`);
                    if (response.ok) {
                        const data = await response.json();
                        this.orders = data;
                        this.countNewOrders();
                    } else {
                        throw new Error(`API trả về lỗi ${response.status}`);
                    }
                } catch (error) {
                    console.warn('Không thể tải danh sách đơn hàng từ API, sử dụng dữ liệu mẫu:', error);
                    // Dữ liệu mẫu
                    this.orders = [
                        {
                            id: 'ORD123456',
                            date: '2024-04-10',
                            status: 'Chờ xác nhận',
                            customerName: 'Nguyễn Văn Linh',
                            customerPhone: '0901234567',
                            deliveryAddress: '123 Nguyễn Huệ, Quận 1, TP.HCM',
                            pickupDate: '2024-04-12',
                            pickupTime: '09:30',
                            notes: 'Gọi trước khi giao',
                            customerId: 'customer1',
                            items: [
                                { id: 1, name: 'Giặt ủi thường', quantity: 3, price: 50000 },
                                { id: 2, name: 'Giặt khô', quantity: 1, price: 80000 }
                            ],
                            totalAmount: 230000,
                            deliveryFee: 15000,
                            grandTotal: 245000,
                            paymentMethod: 'cod'
                        },
                        {
                            id: 'ORD123457',
                            date: '2024-04-09',
                            status: 'Đang xử lý',
                            customerName: 'Trần Thị B',
                            customerPhone: '0912345678',
                            deliveryAddress: '45 Lê Lợi, Quận 1, TP.HCM',
                            pickupDate: '2024-04-11',
                            pickupTime: '14:00',
                            notes: '',
                            customerId: 'customer2',
                            items: [
                                { id: 3, name: 'Giặt nhanh', quantity: 2, price: 100000 },
                                { id: 4, name: 'Giặt đồ da', quantity: 1, price: 150000 }
                            ],
                            totalAmount: 350000,
                            deliveryFee: 15000,
                            grandTotal: 365000,
                            paymentMethod: 'banking'
                        },
                        {
                            id: 'ORD123458',
                            date: '2024-04-08',
                            status: 'Hoàn thành',
                            customerName: 'Lê Văn C',
                            customerPhone: '0923456789',
                            deliveryAddress: '78 Trần Hưng Đạo, Quận 5, TP.HCM',
                            pickupDate: '2024-04-09',
                            pickupTime: '10:15',
                            notes: 'Đồ dễ nhăn, cẩn thận ủi',
                            customerId: 'customer3',
                            items: [
                                { id: 1, name: 'Giặt ủi thường', quantity: 5, price: 50000 }
                            ],
                            totalAmount: 250000,
                            deliveryFee: 15000,
                            grandTotal: 265000,
                            paymentMethod: 'cod'
                        }
                    ];
                    this.countNewOrders();
                }
            } catch (error) {
                console.error('Lỗi khi tải danh sách đơn hàng:', error);
            }
        },
        
        // Kiểm tra đơn hàng mới
        async checkNewOrders() {
            try {
                if (!this.shopId) return;
                
                try {
                    const response = await fetch(`/api/orders/shop/${this.shopId}/new`);
                    if (response.ok) {
                        const data = await response.json();
                        // Cập nhật danh sách nếu có đơn mới
                        if (data.length > 0) {
                            // Kết hợp với danh sách hiện tại, tránh trùng lặp
                            const existingOrderIds = this.orders.map(order => order.id);
                            const newOrders = data.filter(order => !existingOrderIds.includes(order.id));
                            
                            if (newOrders.length > 0) {
                                this.orders = [...newOrders, ...this.orders];
                                this.countNewOrders();
                                
                                // Thông báo có đơn hàng mới
                                this.showNotification(`Bạn có ${newOrders.length} đơn hàng mới`);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Không thể kiểm tra đơn hàng mới:', error);
                }
            } catch (error) {
                console.error('Lỗi khi kiểm tra đơn hàng mới:', error);
            }
        },
        
        // Đếm số đơn hàng mới
        countNewOrders() {
            this.newOrdersCount = this.orders.filter(order => order.status === 'Chờ xác nhận').length;
        },
        
        // Lọc đơn hàng theo tab
        get filteredOrders() {
            if (this.ordersTab === 'all') {
                return this.orders;
            }
            
            const statusMap = {
                'new': 'Chờ xác nhận',
                'processing': 'Đang xử lý',
                'delivering': 'Đang giao',
                'completed': 'Hoàn thành',
                'cancelled': 'Đã hủy'
            };
            
            const status = statusMap[this.ordersTab];
            return this.orders.filter(order => order.status === status);
        },
        
        // Cập nhật trạng thái đơn hàng
        async updateOrderStatus(order, newStatus) {
            if (confirm(`Bạn có chắc muốn chuyển đơn hàng #${order.id} sang trạng thái "${newStatus}"?`)) {
                try {
                    // Gọi API cập nhật trạng thái
                    try {
                        const response = await fetch(`/api/orders/${order.id}/status`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ status: newStatus })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`API trả về lỗi ${response.status}`);
                        }
                    } catch (error) {
                        console.warn('Không thể cập nhật trạng thái đơn hàng thông qua API:', error);
                        // Giả lập cập nhật thành công
                    }
                    
                    // Cập nhật trạng thái trong danh sách
                    order.status = newStatus;
                    
                    // Cập nhật số đơn hàng mới
                    this.countNewOrders();
                    
                    // Thông báo thành công
                    alert(`Đã cập nhật trạng thái đơn hàng thành "${newStatus}"`);
                } catch (error) {
                    console.error('Lỗi khi cập nhật trạng thái đơn hàng:', error);
                    alert('Có lỗi xảy ra khi cập nhật trạng thái đơn hàng. Vui lòng thử lại sau.');
                }
            }
        },
        
        // Hiển thị chi tiết đơn hàng
        showOrderDetails(order) {
            // TODO: Hiển thị modal chi tiết đơn hàng
            alert(`Chi tiết đơn hàng #${order.id}`);
        },
        
        // Mở chat với khách hàng
        openChatWithCustomer(customerId) {
            // Chuyển sang tab chat
            const appData = document.querySelector('[x-data]')?._x_dataStack?.[0];
            if (appData) {
                appData.activeSection = 'chat';
                // TODO: Mở chat với khách hàng có ID tương ứng
                console.log('Mở chat với khách hàng:', customerId);
            }
        },
        
        // Hiển thị thông báo
        showNotification(message) {
            // TODO: Hiển thị thông báo đẹp hơn
            alert(message);
        },
        
        // Lấy class CSS cho trạng thái
        getStatusClass(status) {
            const statusClasses = {
                'Chờ xác nhận': 'bg-yellow-100 text-yellow-800',
                'Đang xử lý': 'bg-blue-100 text-blue-800',
                'Đang giao': 'bg-purple-100 text-purple-800',
                'Hoàn thành': 'bg-green-100 text-green-800',
                'Đã hủy': 'bg-red-100 text-red-800'
            };
            
            return statusClasses[status] || 'bg-gray-100 text-gray-800';
        }
    }));
    });
</script>
</body>
</html>
